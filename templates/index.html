<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis</title>
    <link rel="stylesheet" href="static/style.css">
    <!-- Include Plotly.js for rendering the scatterplot -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Data Analysis</h1>
    
    <!-- Form to select analysis type and column -->
    <form id="analysis-form">
        <label for="analysis-type">Select Analysis Type:</label>
        <select id="analysis-type" name="analysis-type">
            <option value="summary">Summary Statistics</option>
            <option value="scatterplot">Scatterplot</option>
        </select>
        
        <div id="summary-options">
            <label for="column">Select Variable for Analysis:</label>
            <select id="column" name="column">
                <!-- This will be populated dynamically with column names -->
            </select>
        </div>
        
        <div id="scatterplot-options" style="display:none;">
            <label for="x-column">Select X Column:</label>
            <select id="x-column" name="x-column">
                <!-- This will be populated dynamically -->
            </select>

            <label for="y-column">Select Y Column:</label>
            <select id="y-column" name="y-column">
                <!-- This will be populated dynamically -->
            </select>

            <label for="color-by">Color By (Optional):</label>
            <select id="color-by" name="color-by">
                <option value="">None</option>
                <!-- This will be populated dynamically with categorical variables -->
            </select>
        </div>
        
        <button type="submit">Analyze</button>
    </form>

    <!-- Where the summary statistics or scatterplot will be displayed -->
    <div id="analysis-results"></div>

    <!-- Include the JavaScript file -->
    <script>
        window.onload = function() {
            const numericalColumns = {{ numerical_columns | tojson }};
            const categoricalColumns = {{ categorical_columns | tojson }};

            // Populate numerical column dropdowns
            const columnSelect = document.getElementById('column');
            const xColumnSelect = document.getElementById('x-column');
            const yColumnSelect = document.getElementById('y-column');

            numericalColumns.forEach(function(column) {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                columnSelect.appendChild(option.cloneNode(true));
                xColumnSelect.appendChild(option.cloneNode(true));
                yColumnSelect.appendChild(option.cloneNode(true));
            });

            // Populate categorical column dropdown
            const colorBySelect = document.getElementById('color-by');
            categoricalColumns.forEach(function(column) {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                colorBySelect.appendChild(option);
            });
        };

        document.getElementById('analysis-form').addEventListener('submit', function(event) {
            event.preventDefault();  // Prevent the default form submission behavior

            const analysisType = document.getElementById('analysis-type').value;
            const column = document.getElementById('column').value;
            
            const requestData = { analysis_type: analysisType };

            // Include column for summary statistics
            if (analysisType === 'summary') {
                if (!column) {
                    alert('Please select a column for summary statistics');
                    return;
                }
                requestData.column = column;
            }

            // Scatterplot logic remains unchanged
            if (analysisType === 'scatterplot') {
                const xColumn = document.getElementById('x-column').value;
                const yColumn = document.getElementById('y-column').value;
                const colorBy = document.getElementById('color-by').value;

                if (!xColumn || !yColumn) {
                    alert('Please select both X and Y columns for scatterplot');
                    return;
                }

                requestData.x_column = xColumn;
                requestData.y_column = yColumn;
                if (colorBy) {
                    requestData.color_by = colorBy;
                }
            }

            // Send the POST request to the Flask server
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)  // Convert the request data to JSON format
            })
            .then(response => response.json())  // Parse the response as JSON
            .then(data => {
                if (data.error) {
                    // If there is an error in the response, display the error message
                    console.error('Error:', data.error);
                    alert(data.error);
                } else {
                    // Display results based on analysis type
                    let resultDiv = document.getElementById('analysis-results');
                    resultDiv.innerHTML = '';  // Clear previous results

                    if (analysisType === 'summary') {
                        // Display summary statistics
                        for (let stat in data) {
                            if (stat !== 'plot') {  // Ignore the plot key for now
                                resultDiv.innerHTML += `<p><strong>${stat}:</strong> ${data[stat]}</p>`;
                            }
                        }
                        // Display the plot image
                        if (data.plot) {
                            const img = document.createElement('img');
                            img.src = `data:image/png;base64,${data.plot}`;
                            img.alt = 'Histogram or Bar Chart';
                            resultDiv.appendChild(img);
                        }
                    }
                    else if (analysisType === 'scatterplot') {
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${data.plot}`;
                        img.alt = 'Scatterplot';
                        resultDiv.appendChild(img);

                        if (data.regressions) {
                            for (const category in data.regressions) {
                                const regression = data.regressions[category];
                                resultDiv.innerHTML += `<p><strong>${category} Regression:</strong> ${regression.equation}</p>`;
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error processing your request.');
            });
        });

        // Show scatterplot-specific options when the scatterplot analysis type is selected
        document.getElementById('analysis-type').addEventListener('change', function() {
            const summaryOptions = document.getElementById('summary-options');
            const scatterplotOptions = document.getElementById('scatterplot-options');

            if (this.value === 'scatterplot') {
                summaryOptions.style.display = 'none';
                scatterplotOptions.style.display = 'block';
            } else {
                summaryOptions.style.display = 'block';
                scatterplotOptions.style.display = 'none';
            }
        });
    </script>
</body>
</html>
