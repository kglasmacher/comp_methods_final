<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis</title>
    <!-- Include Plotly.js for rendering the scatterplot -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Data Analysis</h1>
    
    <!-- Form to select analysis type and column -->
    <form id="analysis-form">
        <label for="analysis-type">Select Analysis Type:</label>
        <select id="analysis-type" name="analysis-type">
            <option value="summary">Summary Statistics</option>
            <option value="scatterplot">Scatterplot</option>
        </select>
        
        <label for="column">Select a column:</label>
        <select id="column" name="column">
            <!-- This will be populated dynamically with column names -->
        </select>
        
        <div id="scatterplot-options" style="display:none;">
            <label for="x-column">Select X Column:</label>
            <select id="x-column" name="x-column">
                <!-- This will be populated dynamically -->
            </select>

            <label for="y-column">Select Y Column:</label>
            <select id="y-column" name="y-column">
                <!-- This will be populated dynamically -->
            </select>
        </div>
        
        <button type="submit">Analyze</button>
    </form>

    <!-- Where the summary statistics or scatterplot will be displayed -->
    <div id="analysis-results"></div>

    <!-- Include the JavaScript file -->
    <script>
        window.onload = function() {
            // Get column names from the Flask backend and populate the dropdowns
            const columns = {{ columns | tojson }};  // This is passed from Flask to the frontend

            const columnSelect = document.getElementById('column');
            const xColumnSelect = document.getElementById('x-column');
            const yColumnSelect = document.getElementById('y-column');
            
            // Create option elements for each column and add them to the dropdown
            columns.forEach(function(column) {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                columnSelect.appendChild(option);
                xColumnSelect.appendChild(option.cloneNode(true));
                yColumnSelect.appendChild(option.cloneNode(true));
            });
        };

        document.getElementById('analysis-form').addEventListener('submit', function(event) {
            event.preventDefault();  // Prevent the default form submission behavior

            const analysisType = document.getElementById('analysis-type').value;
            const column = document.getElementById('column').value;
            const xColumn = document.getElementById('x-column').value;
            const yColumn = document.getElementById('y-column').value;

            // Prepare the request data as an object
            const requestData = {
                analysis_type: analysisType,
                column: column
            };

            if (analysisType === 'scatterplot') {
                requestData.x_column = xColumn;
                requestData.y_column = yColumn;
            }

            // Send the POST request to the Flask server
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)  // Convert the request data to JSON format
            })
            .then(response => response.json())  // Parse the response as JSON
            .then(data => {
                if (data.error) {
                    // If there is an error in the response, display the error message
                    console.error('Error:', data.error);
                    alert(data.error);
                } else {
                    // Display results based on analysis type
                    let resultDiv = document.getElementById('analysis-results');
                    resultDiv.innerHTML = '';  // Clear previous results

                    if (analysisType === 'summary') {
                        // Display summary statistics
                        for (let stat in data) {
                            resultDiv.innerHTML += `<p><strong>${stat}:</strong> ${data[stat]}</p>`;
                        }
                    } else if (analysisType === 'scatterplot') {
                        // Render the scatterplot using Plotly.js
                        const trace = {
                            x: data.x,
                            y: data.y,
                            mode: 'markers',
                            type: 'scatter',
                            name: `${data.x_label} vs ${data.y_label}`
                        };
                        const layout = {
                            title: `${data.x_label} vs ${data.y_label}`,
                            xaxis: { title: data.x_label },
                            yaxis: { title: data.y_label }
                        };
                        const plotData = [trace];
                        Plotly.newPlot('analysis-results', plotData, layout);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error processing your request.');
            });
        });

        // Show scatterplot-specific options when the scatterplot analysis type is selected
        document.getElementById('analysis-type').addEventListener('change', function() {
            const scatterplotOptions = document.getElementById('scatterplot-options');
            if (this.value === 'scatterplot') {
                scatterplotOptions.style.display = 'block';
            } else {
                scatterplotOptions.style.display = 'none';
            }
        });
    </script>
</body>
</html>
